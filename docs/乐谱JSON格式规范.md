# 乐谱 JSON 格式规范

## 1. 概述

本文档说明如何将简谱（数字谱）转换为拇指琴可播放的 JSON 格式乐谱。

## 2. JSON 格式结构

乐谱是一个 JSON 数组，每个元素代表一个音符或休止符：

```json
[
  {"code": "C4", "duration": "16"},
  {"code": "G4", "duration": "8"},
  {"code": "-", "duration": "16"}
]
```

### 2.1 字段说明

- **`code`** (string): 音符代码或休止符
  - 音符格式：`{音名}{八度}`，如 `C4`, `G5`, `A4`
  - 休止符：使用 `"-"` 表示
- **`duration`** (string): 时值单位数（字符串格式）
  - 以 1/64 拍为最小单位
  - 例如：`"16"` 表示 16 个单位 = 1/4 拍（四分音符）

## 3. 简谱到音符映射规则

### 3.1 基本音名映射

简谱数字（1-7）对应音名：

| 简谱数字 | 音名 | 唱名 |
|---------|------|------|
| 1 | C | do |
| 2 | D | re |
| 3 | E | mi |
| 4 | F | fa |
| 5 | G | sol |
| 6 | A | la |
| 7 | B | si |

### 3.2 八度标记规则

- **无标记**：默认中音区（C4-B4）
- **数字上方一个点** (`i`)：高八度（C5-B5）
- **数字上方两个点** (`ii`)：更高八度（C6-E6，根据拇指琴音域限制）

**示例：**
- `5` → `G4`（中音 sol）
- `i5` → `G5`（高音 sol）
- `ii5` → `G5`（更高音 sol，但拇指琴最高到 E6，需根据实际音域调整）

### 3.3 拇指琴 17 键音域

标准 C 调 17 键拇指琴从左到右的音符：

| 位置 | 音符 | 简谱标记 | 八度点 |
|-----|------|---------|--------|
| 0 | D6 | 2 | 两点 |
| 1 | B5 | 7 | 一点 |
| 2 | G5 | 5 | 一点 |
| 3 | E5 | 3 | 一点 |
| 4 | C5 | 1 | 一点 |
| 5 | A4 | 6 | 无 |
| 6 | F4 | 4 | 无 |
| 7 | D4 | 2 | 无 |
| 8 | C4 | 1 | 无（中心键，最长） |
| 9 | E4 | 3 | 无 |
| 10 | G4 | 5 | 无 |
| 11 | B4 | 7 | 无 |
| 12 | D5 | 2 | 一点 |
| 13 | F5 | 4 | 一点 |
| 14 | A5 | 6 | 一点 |
| 15 | C6 | 1 | 两点 |
| 16 | E6 | 3 | 两点 |

**注意：** 如果简谱中的音符超出此音域，需要调整到最接近的可演奏音符。

## 4. 时值转换规则

### 4.1 时值单位说明

- **最小单位**：1/64 拍
- **基准速度**：BPM = 120（四分音符 = 0.5 秒）
- **单位时长**：1 个单位 = 0.5/16 = 0.03125 秒 ≈ 31.25ms

### 4.2 简谱时值标记

| 简谱标记 | 时值名称 | 单位数 | duration 值 |
|---------|---------|--------|-------------|
| 无下划线 | 四分音符 | 16 | `"16"` |
| 单下划线 `_` | 八分音符 | 8 | `"8"` |
| 双下划线 `__` | 十六分音符 | 4 | `"4"` |
| 三下划线 `___` | 三十二分音符 | 2 | `"2"` |
| 点（附点） | 原时值 × 1.5 | - | 需计算 |

**示例：**
- `5` → `{"code": "G4", "duration": "16"}`（四分音符）
- `5_` → `{"code": "G4", "duration": "8"}`（八分音符）
- `5__` → `{"code": "G4", "duration": "4"}`（十六分音符）

### 4.3 连音处理

多个音符共享下划线时，每个音符的时值按连音总数均分：

- `4565` 下有一条下划线 → 四个十六分音符，每个 `duration: "4"`

## 5. 休止符处理

- 简谱中的 `0` 或 `-` 表示休止符
- JSON 中使用 `{"code": "-", "duration": "..."}`
- 时值转换规则与音符相同

## 6. 转换示例

### 6.1 简单示例

**简谱：**
```
6 i 5 i
```

**转换步骤：**
1. `6` → A4，无下划线 → 四分音符 → `{"code": "A4", "duration": "16"}`
2. `i` → C5（高音 do），无下划线 → 四分音符 → `{"code": "C5", "duration": "16"}`
3. `5` → G4，无下划线 → 四分音符 → `{"code": "G4", "duration": "16"}`
4. `i` → C5，无下划线 → 四分音符 → `{"code": "C5", "duration": "16"}`

**JSON：**
```json
[
  {"code": "A4", "duration": "16"},
  {"code": "C5", "duration": "16"},
  {"code": "G4", "duration": "16"},
  {"code": "C5", "duration": "16"}
]
```

### 6.2 带时值标记示例

**简谱：**
```
6_ i_ 5_ i_
```

**转换：**
- 所有音符都有单下划线（八分音符）
- 每个音符 `duration: "8"`

**JSON：**
```json
[
  {"code": "A4", "duration": "8"},
  {"code": "C5", "duration": "8"},
  {"code": "G4", "duration": "8"},
  {"code": "C5", "duration": "8"}
]
```

### 6.3 连音示例

**简谱：**
```
4565__  （四个数字共享双下划线）
```

**转换：**
- 四个音符，每个是十六分音符
- `duration: "4"`

**JSON：**
```json
[
  {"code": "F4", "duration": "4"},
  {"code": "G4", "duration": "4"},
  {"code": "F4", "duration": "4"},
  {"code": "G4", "duration": "4"}
]
```

### 6.4 休止符示例

**简谱：**
```
5_ 0_ 5_
```

**JSON：**
```json
[
  {"code": "G4", "duration": "8"},
  {"code": "-", "duration": "8"},
  {"code": "G4", "duration": "8"}
]
```

## 7. 完整转换流程

1. **识别简谱元素**
   - 提取数字（1-7）
   - 识别八度标记（点）
   - 识别时值标记（下划线）

2. **映射音名和八度**
   - 数字 → 音名（C, D, E, F, G, A, B）
   - 八度标记 → 确定八度（4, 5, 6）
   - 组合成音符代码（如 `C4`, `G5`）

3. **转换时值**
   - 下划线数量 → 单位数
   - 无下划线 = 16，单下划线 = 8，双下划线 = 4，三下划线 = 2

4. **生成 JSON**
   - 每个音符/休止符生成一个对象
   - 按顺序组成数组

## 8. 注意事项

1. **音域限制**：如果简谱中的音符超出 17 键拇指琴音域（C4-E6），需要调整到最接近的可演奏音符。

2. **时值精度**：系统支持的最小单位是 1/64 拍，更小的时值需要四舍五入到最接近的单位。

3. **调号处理**：本文档默认 C 调（1=C）。如果简谱标注其他调号，需要按调号关系调整音符。

4. **速度标记**：简谱中的速度标记（如 `♩=70`）仅供参考，系统默认使用 BPM=120。如需调整速度，需要修改播放器的 BPM 设置。

5. **小节线**：小节线（`|`）在 JSON 中不需要表示，仅用于阅读。

## 9. 工具建议

建议开发一个简谱到 JSON 的转换工具，可以：
- 解析简谱文本或图片
- 自动识别音符、时值、休止符
- 生成标准 JSON 格式
- 验证音符是否在音域内

