## 1. 目标
- 构建一个基于 React + Vite + TypeScript 的音乐可视化页面。
- 支持在线音频链接、本地文件以及实时流式和弦三种输入源，统一通过 Web Audio API 播放与分析。
- 提供基础播放控制与至少一种可视化效果（频谱柱状图），为后续扩展保留接口。

## 2. 功能范围
- 音源管理：文本框输入 HTTP(S) 链接、文件选择器上传本地音频、按钮启动实时流式和弦或虚拟拇指琴。
- 播放控制：播放 / 暂停 / 停止、音量调节、加载状态提示。
- 可视化：使用 `<canvas>` 绘制实时频谱，可切换到波形等其他样式（后续迭代）。
- 错误提示：音频加载失败、解码失败、URL 校验不通过等场景的友好反馈。

## 3. 技术方案概述
- **音频管线**  
  - 延迟创建 `AudioContext`，首次用户交互时初始化以满足浏览器策略。  
- 远程音频：使用 `<audio>` 元素 + `MediaElementAudioSourceNode`。  
- 本地音频：读取 `File`，通过 `audioContext.decodeAudioData` -> `AudioBufferSourceNode`。  
- 流式和弦：通过 `AudioWorkletNode` 挂载自定义处理器（实时生成随机和弦），仅在播放状态输出，无法 seek。
- 虚拟拇指琴：直接使用 `OscillatorNode + GainNode` 构建 17 键触发器，按需生成包络并连接 analyser。
  - 公共 `AnalyserNode` 连接到 `AudioContext.destination`，可复用给多种可视化组件。
- **状态管理**  
  - React 组件内使用 `useState` 存储播放状态、音量、当前音源信息。  
  - 自定义 hook（例如 `useAudioVisualizer`）封装 audio context、analyser、RAF 循环的创建与清理。
- **渲染层**  
  - 主要组件：`AudioControls`, `SourceSelector`, `VisualizerCanvas`。  
  - Canvas 绘制使用 `requestAnimationFrame` 循环与 `AnalyserNode.getByteFrequencyData`。

## 4. 组件拆分
- `SourceSelector`：输入远程 URL、校验格式；本地文件选择并回传 `File`；额外按钮触发实时和弦流或拇指琴模式。
- `KalimbaKeyboard`：17 键布局（拇指琴按键），调用 `useAudioEngine` 对应触发方法。
- `AudioControls`：播放控制按钮、时间信息、音量滑块。
- `VisualizerCanvas`：接收 analyser 与配置，渲染频谱/波形。
- `useAudioEngine` hook：统一管理 `AudioContext`、音源节点、播放控制。
- `useVisualizer` hook：管理 RAF、读取频谱数据、触发重绘。

## 5. 数据流与状态
- 顶层页面维护当前音源描述对象：`{ type: 'url' | 'file' | 'stream', ... }`。
- 选择音源后调用 `useAudioEngine.loadSource`，内部返回 Promise 处理异步加载/解码。
- 播放状态（`idle | loading | playing | paused`）由 `useAudioEngine` 暴露，供 UI 控制按钮禁用。
- 可视化设置（例如模式、颜色）存于父组件并传给 `VisualizerCanvas`。

## 6. 可视化实现细节
- 默认为柱状频谱：获取 `Uint8Array` 频域数据，映射到 canvas 宽度的若干条柱子。
- 支持切换到波形：使用 `getByteTimeDomainData` 并绘制折线。
- 可调整 analyser 参数：`fftSize`、`smoothingTimeConstant` 通过配置传入，便于调优。
- RAF 循环需在组件卸载时取消，并在暂停/停止时停止绘制以节能。

## 7. 错误与性能考量
- URL 输入进行基本校验（`/^https?:\\/\\//`），并在 `audio` 元素的 `onerror` 中反馈。
- 本地文件类型限制在常见音频 MIME（`audio/*`），并捕获 `decodeAudioData` 异常。
- 复用单例 `AudioContext`，避免多次创建导致资源浪费。
- 在可视化循环中避免创建临时对象，`Uint8Array` 预先分配。

## 8. 后续扩展
- 增加可视化主题（颜色、自定义 shader）。
- 引入全局状态管理（如 Zustand）支持多页面交互。
- 提供录音/麦克风输入，做实时波形展示。
- 打包成可嵌入的小组件或提供导出 GIF 的能力。

